# Chrome拡張機能の要件

## 機能

### 設定画面

- 設定画面で以下の項目を設定できる。いずれも必須項目とする。
  - kintoneのドメイン
  - kintoneのユーザー名
  - kintoneのパスワード
  - 自動入力を有効にするかどうかのチェックボックス

- 設定画面は、Chromeの拡張機能のオプションページとして実装する。

### 任意のWebサイト上

- 画像を右クリックすると、コンテキストメニューに「ワンタイムパスワードを登録する」という項目が表示される。
  - クリックすると、画像をQRコードとして読み取って、それがOTPAuth URIである場合は登録画面を開く。
  - 画像がOTPAuth URIでない場合は、「読み取れませんでした」というエラーメッセージを表示する。
  - imgタグのほか、canvasタグやSVGタグ、background-imageとして設定された画像も対象とする。

- 入力フィールドを右クリックすると、「kintoneから入力する」という項目が表示される。
  - 項目をクリックすると、現在開いているページのURLで絞り込んだ状態の選択画面が表示される。
  - 選択画面で値を選択すると、その値が入力フィールドに設定される。

- 今開いているページがkintoneに登録してあるURLと一致しており、なおかつ「username」「email」「password」などの名前の入力フィールドが存在する場合、自動でユーザー名やパスワードを入力する。
  - この機能は、ページが読み込まれたときに自動的に実行される。
  - URLの一致は、ワイルドカード(`*`)を考慮する。
  - 複数一致している場合は、登録されているURLが最も長いものを優先する。長さが同じ場合は、最終更新が新しいものを優先する。
  - 設定画面で「自動入力を有効にする」のチェックが外れている場合は、この機能は実行されない。

- すべてのコンテキストメニューは、設定が完了している場合にのみ表示される。

### 選択画面

- 選択画面は、Chromeの拡張機能のポップアップとして実装する。

- 拡張機能のアイコンをクリックすると、選択画面が表示される。

- 選択画面には、kintoneに登録してあるユーザー名、パスワード、ワンタイムパスワードなどの情報を表示する。
  - ユーザー名やパスワードは、kintoneのアプリから取得する。
  - ワンタイムパスワードは、kintoneに登録してあるOTPAuth URIを元に計算する。
  - 表示されている情報をクリックすると、画面を開いた経路に応じて以下の動作をする。
    - 入力フィールドを右クリック → 「kintoneから入力する」 → 「その他」の順に場合： 選択した値が入力フィールドに設定される。
    - 拡張機能のアイコンから開いた場合： 選択した値がクリップボードにコピーされ、「コピーしました」というメッセージを表示する。

- 選択画面には検索フィールドがあり、「名前」と「URL」でフィルタリングできる。
  - 検索フィールドに入力すると、リアルタイムでフィルタリングされる。
  - 検索クエリは大文字小文字を一致せず、部分一致で検索する。スペース区切りの場合は、各単語でAND検索する。

- 選択画面の右下には「＋」というボタンがあり、クリックすると登録画面が開く。

- 選択画面の上部には更新アイコンのボタンがあり、クリックするとkintoneから最新の情報を取得して表示する。
  - このとき、kintoneに接続できない場合はキャッシュの有無に関わらずエラーメッセージを表示する。

- まだ設定が完了していない場合は、その旨を表示して設定画面へのリンクを表示する。

### 登録画面

- 登録画面は、Chromeの拡張機能のポップアップとして実装する。

- 登録画面には、以下の項目を入力するフィールドがある。
  - サイトの名前
  - URL（ワイルドカード(`*`)を含む）
  - ユーザー名
  - パスワード

- フィールドには可能な限りデフォルトで値を設定する。
  - サイトの名前は、現在開いているページのタイトルをデフォルト値とする。
  - URLは、現在開いているページのURLをデフォルト値とする。

- 「登録」ボタンをクリックすると、入力された情報をkintoneに登録する。
  - このとき、OTPAuth URIのQRコードから読み取って登録画面を開いた場合は、OTPAuth URIも一緒に登録する。
  - 登録が成功した場合は、選択画面に戻る。
  - 登録が失敗した場合は、エラーメッセージを表示する。


## セキュリティ

- 設定画面で登録した値は、ChromeのストレージAPIを使用して安全に保存する。


## パフォーマンス

- kintoneの情報はキャッシュしておき、kintoneに接続できない場合でも高速に動作するようにする。

- キャッシュのageが5分を越えた場合は、Stale-While-Revalidateの手法で最新情報を取得してキャッシュを更新する。


## デザイン

- kintoneのデザインに合わせたシンプルなデザインとする。


## 動作環境とバージョン

- Google Chromeの最新版のみをサポート対象とする。

- マニフェストのバージョンは3を使用する。

- 実装をシンプルに保つために、可能な限り最新の機能を使用する。
